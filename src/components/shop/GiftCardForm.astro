---
import { useTranslations } from '@i18n/utils';
import type { Langs } from '@i18n/ui';
import FormInput from '@components/form-fields/FormInput.astro';
import FormTextarea from '@components/form-fields/FormTextarea.astro';
import Button from '@components/buttons/Button.astro';

interface Props {
	lang: Langs;
}

const { lang } = Astro.props;
const t = useTranslations(lang);

// Stripe public key - will be replaced with env variable
const stripePublicKey = import.meta.env.PUBLIC_STRIPE_PUBLISHABLE_KEY || 'pk_test_placeholder';
---

<form id="gift-card-form" class="gift-card-form" data-stripe-key={stripePublicKey}>
	<input type="hidden" id="selected-amount" name="amount" value="45" />
	<input type="hidden" id="selected-sessions" name="sessions" value="1" />
	
	<div class="form-section">
		<h3>{lang === 'eu' ? 'Hartzailearen datuak' : 'Datos del destinatario'}</h3>
		<div class="form-grid">
			<div class="form-field">
				<label for="recipient-name">{t('shop.recipient-name')} *</label>
				<input 
					type="text" 
					id="recipient-name" 
					name="recipientName" 
					required 
					class="input"
				/>
			</div>
			<div class="form-field">
				<label for="recipient-email">{t('shop.recipient-email')}</label>
				<input 
					type="email" 
					id="recipient-email" 
					name="recipientEmail" 
					class="input"
				/>
			</div>
		</div>
		<div class="form-field">
			<label for="gift-message">{t('shop.personal-message')}</label>
			<textarea 
				id="gift-message" 
				name="giftMessage" 
				rows="3"
				placeholder={t('shop.gift-message-placeholder')}
				class="textarea"
			></textarea>
		</div>
	</div>

	<div class="form-section">
		<h3>{lang === 'eu' ? 'Zure datuak' : 'Tus datos'}</h3>
		<div class="form-grid">
			<div class="form-field">
				<label for="sender-name">{t('shop.sender-name')} *</label>
				<input 
					type="text" 
					id="sender-name" 
					name="senderName" 
					required 
					class="input"
				/>
			</div>
			<div class="form-field">
				<label for="sender-email">{t('shop.sender-email')} *</label>
				<input 
					type="email" 
					id="sender-email" 
					name="senderEmail" 
					required 
					class="input"
				/>
			</div>
		</div>
	</div>

	<!-- Order Summary -->
	<div class="order-summary">
		<h3>{lang === 'eu' ? 'Eskaera laburpena' : 'Resumen del pedido'}</h3>
		<div class="summary-row">
			<span>{t('shop.gift-card')}</span>
			<span class="summary-amount">45€</span>
		</div>
		<div class="summary-total">
			<span>{t('shop.total')}</span>
			<span class="total-amount">45€</span>
		</div>
	</div>

	<!-- Stripe Card Element will be mounted here -->
	<div class="payment-section">
		<h3>{t('shop.secure-payment')}</h3>
		<div id="card-element" class="card-element"></div>
		<div id="card-errors" class="card-errors" role="alert"></div>
		<p class="stripe-info">
			<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
				<circle cx="12" cy="16" r="1"></circle>
				<path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
			</svg>
			{t('shop.powered-by-stripe')}
		</p>
	</div>

	<button type="submit" class="submit-btn" id="submit-btn">
		<span class="btn-text">{t('shop.buy-now')}</span>
		<span class="btn-loading" style="display: none;">{t('shop.processing')}</span>
	</button>

	<!-- Success/Error Messages -->
	<div id="payment-success" class="message success" style="display: none;">
		<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
			<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
			<polyline points="22,4 12,14.01 9,11.01"></polyline>
		</svg>
		<p>{t('shop.payment-success')}</p>
		<p class="sub-message">{t('shop.email-sent')}</p>
		<button type="button" id="download-pdf" class="download-btn">{t('shop.download-pdf')}</button>
	</div>

	<div id="payment-error" class="message error" style="display: none;">
		<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
			<circle cx="12" cy="12" r="10"></circle>
			<line x1="15" y1="9" x2="9" y2="15"></line>
			<line x1="9" y1="9" x2="15" y2="15"></line>
		</svg>
		<p>{t('shop.payment-error')}</p>
	</div>
</form>

<style>
	.gift-card-form {
		max-width: 600px;
		margin: 0 auto;
		padding: var(--s5);
		background: var(--theme-bg);
		border-radius: var(--theme-shape-radius);
		box-shadow: var(--shadow-md);
	}

	.form-section {
		margin-bottom: var(--s5);
	}

	.form-section h3 {
		margin: 0 0 var(--s4);
		font-size: 1.125rem;
		color: var(--theme-on-bg);
		padding-bottom: var(--s3);
		border-bottom: 1px solid var(--theme-outline);
	}

	.form-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: var(--s4);
	}

	.form-field {
		display: flex;
		flex-direction: column;
		margin-bottom: var(--s4);
	}

	.form-field label {
		margin-bottom: var(--s);
		font-size: 0.875rem;
		font-weight: 500;
		color: var(--theme-on-bg);
	}

	.input,
	.textarea {
		padding: var(--s3) var(--s4);
		border: 1px solid var(--theme-outline);
		border-radius: calc(var(--theme-shape-radius) / 2);
		background: var(--theme-bg);
		color: var(--theme-on-bg);
		font-size: 1rem;
		transition: border-color var(--theme-transition);
	}

	.input:focus,
	.textarea:focus {
		outline: none;
		border-color: var(--theme-primary);
	}

	.textarea {
		resize: vertical;
		min-height: 80px;
	}

	/* Order Summary */
	.order-summary {
		margin-bottom: var(--s5);
		padding: var(--s4);
		background: var(--theme-surface-1);
		border-radius: calc(var(--theme-shape-radius) / 2);
	}

	.order-summary h3 {
		margin: 0 0 var(--s3);
		font-size: 1rem;
		color: var(--theme-on-bg);
	}

	.summary-row {
		display: flex;
		justify-content: space-between;
		padding: var(--s) 0;
		color: var(--theme-text-secondary);
	}

	.summary-total {
		display: flex;
		justify-content: space-between;
		padding-top: var(--s3);
		margin-top: var(--s3);
		border-top: 1px solid var(--theme-outline);
		font-weight: 700;
		font-size: 1.125rem;
		color: var(--theme-on-bg);
	}

	.total-amount {
		color: var(--theme-primary);
	}

	/* Payment Section */
	.payment-section {
		margin-bottom: var(--s5);
	}

	.payment-section h3 {
		margin: 0 0 var(--s4);
		font-size: 1.125rem;
		color: var(--theme-on-bg);
	}

	.card-element {
		padding: var(--s4);
		border: 1px solid var(--theme-outline);
		border-radius: calc(var(--theme-shape-radius) / 2);
		background: var(--theme-bg);
	}

	.card-errors {
		margin-top: var(--s3);
		color: var(--theme-error);
		font-size: 0.875rem;
	}

	.stripe-info {
		display: flex;
		align-items: center;
		gap: var(--s);
		margin-top: var(--s3);
		font-size: 0.875rem;
		color: var(--theme-text-secondary);
	}

	.stripe-info svg {
		color: var(--theme-secondary);
	}

	/* Submit Button */
	.submit-btn {
		width: 100%;
		padding: var(--s4);
		background: var(--theme-primary);
		color: var(--theme-on-primary);
		border: none;
		border-radius: var(--theme-button-border-radius);
		font-size: 1.125rem;
		font-weight: 600;
		cursor: pointer;
		transition: background var(--theme-transition);
	}

	.submit-btn:hover:not(:disabled) {
		background: var(--theme-primary-dark);
	}

	.submit-btn:disabled {
		opacity: 0.7;
		cursor: not-allowed;
	}

	/* Messages */
	.message {
		display: flex;
		flex-direction: column;
		align-items: center;
		margin-top: var(--s5);
		padding: var(--s5);
		border-radius: calc(var(--theme-shape-radius) / 2);
		text-align: center;
	}

	.message.success {
		background: var(--theme-primary-100);
		border: 1px solid var(--theme-primary);
	}

	.message.error {
		background: #fef2f2;
		border: 1px solid var(--theme-error);
	}

	.message svg {
		margin-bottom: var(--s3);
	}

	.message.success svg {
		color: var(--theme-primary);
	}

	.message.error svg {
		color: var(--theme-error);
	}

	.message p {
		margin: 0;
		font-weight: 600;
	}

	.sub-message {
		font-weight: 400 !important;
		color: var(--theme-text-secondary);
		margin-top: var(--s) !important;
	}

	.download-btn {
		margin-top: var(--s4);
		padding: var(--s3) var(--s4);
		background: var(--theme-primary);
		color: var(--theme-on-primary);
		border: none;
		border-radius: var(--theme-button-border-radius);
		font-size: 1rem;
		cursor: pointer;
	}

	.download-btn:hover {
		background: var(--theme-primary-dark);
	}
</style>

<script>
	// This script will be loaded when Stripe is available
	declare global {
		interface Window {
			Stripe: any;
		}
	}

	// Load Stripe.js
	const loadStripe = () => {
		return new Promise<void>((resolve) => {
			if (window.Stripe) {
				resolve();
				return;
			}
			const script = document.createElement('script');
			script.src = 'https://js.stripe.com/v3/';
			script.onload = () => resolve();
			document.head.appendChild(script);
		});
	};

	// Initialize form
	document.addEventListener('DOMContentLoaded', async () => {
		const form = document.getElementById('gift-card-form') as HTMLFormElement;
		const stripeKey = form?.dataset.stripeKey;
		
		if (!stripeKey || stripeKey === 'pk_test_placeholder') {
			console.warn('Stripe key not configured');
			return;
		}

		await loadStripe();

		const stripe = window.Stripe(stripeKey);
		const elements = stripe.elements();
		
		const cardElement = elements.create('card', {
			style: {
				base: {
					fontSize: '16px',
					color: '#424770',
					'::placeholder': {
						color: '#aab7c4',
					},
				},
				invalid: {
					color: '#9e2146',
				},
			},
		});
		
		cardElement.mount('#card-element');

		// Handle card errors
		cardElement.on('change', (event: any) => {
			const displayError = document.getElementById('card-errors');
			if (displayError) {
				displayError.textContent = event.error ? event.error.message : '';
			}
		});

		// Update order summary when amount changes
		const selectedAmountInput = document.getElementById('selected-amount') as HTMLInputElement;
		const summaryAmount = document.querySelector('.summary-amount');
		const totalAmount = document.querySelector('.total-amount');

		const updateSummary = (amount: string) => {
			if (summaryAmount) summaryAmount.textContent = `${amount}€`;
			if (totalAmount) totalAmount.textContent = `${amount}€`;
		};

		// Listen for card selection
		document.querySelectorAll('.gift-card-option').forEach(card => {
			card.addEventListener('click', () => {
				const price = card.getAttribute('data-price');
				if (price) {
					selectedAmountInput.value = price;
					updateSummary(price);
				}
			});
		});

		// Listen for custom amount
		const customAmountInput = document.getElementById('custom-amount') as HTMLInputElement;
		if (customAmountInput) {
			customAmountInput.addEventListener('input', () => {
				selectedAmountInput.value = customAmountInput.value;
				updateSummary(customAmountInput.value || '0');
			});
		}

		// Handle form submission
		form.addEventListener('submit', async (e) => {
			e.preventDefault();

			const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
			const btnText = submitBtn.querySelector('.btn-text') as HTMLElement;
			const btnLoading = submitBtn.querySelector('.btn-loading') as HTMLElement;
			const successMessage = document.getElementById('payment-success');
			const errorMessage = document.getElementById('payment-error');

			// Show loading state
			submitBtn.disabled = true;
			btnText.style.display = 'none';
			btnLoading.style.display = 'inline';
			successMessage!.style.display = 'none';
			errorMessage!.style.display = 'none';

			try {
				// Get form data
				const formData = new FormData(form);
				const data = Object.fromEntries(formData);

				// Create payment intent on server
				const response = await fetch('/api/shop/create-payment-intent', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(data),
				});

				const { clientSecret, error: serverError } = await response.json();

				if (serverError) {
					throw new Error(serverError);
				}

				// Confirm payment
				const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
					payment_method: {
						card: cardElement,
						billing_details: {
							name: data.senderName as string,
							email: data.senderEmail as string,
						},
					},
				});

				if (error) {
					throw new Error(error.message);
				}

				if (paymentIntent.status === 'succeeded') {
					// Generate gift card
					const giftCardResponse = await fetch('/api/shop/generate-gift-card', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							...data,
							paymentIntentId: paymentIntent.id,
						}),
					});

					const { pdfUrl, error: giftCardError } = await giftCardResponse.json();

					if (giftCardError) {
						console.error('Gift card generation error:', giftCardError);
					}

					// Show success message
					successMessage!.style.display = 'flex';
					form.style.display = 'none';

					// Set up PDF download
					const downloadBtn = document.getElementById('download-pdf');
					if (downloadBtn && pdfUrl) {
						downloadBtn.addEventListener('click', () => {
							window.open(pdfUrl, '_blank');
						});
					}
				}
			} catch (err: any) {
				errorMessage!.style.display = 'flex';
				const errorElement = document.getElementById('card-errors');
				if (errorElement) {
					errorElement.textContent = err.message;
				}
			} finally {
				submitBtn.disabled = false;
				btnText.style.display = 'inline';
				btnLoading.style.display = 'none';
			}
		});
	});
</script>
