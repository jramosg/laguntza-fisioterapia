---
import Burger from '@components/buttons/Burger.astro';
import { nav, type NavItem } from '@config/nav';
import { getLangFromUrl, useTranslations } from '@i18n/utils';
import LanguageToggle from '@components/LanguageToggle.astro';
import 'theme-toggles/css/classic.css';
import LogoIsotipoWhite from '@images/logos/isotipo-white.svg';

type Props = {
	navData: NavItem[];
	rightMenu?: boolean;
};
const { navData, rightMenu }: Props = Astro.props;

const url = Astro.url;
const lang = getLangFromUrl(url);
const t = useTranslations(lang);
---

<header
	id="laguntzaFisioterapiaNavHeader"
	class={`${rightMenu ? 'header--right' : ``.trim()}`}
>
	<div class="header-logo-menu__container">
		<a class="header-logo__link" href={`/${lang}`}>
			<slot name="logo" />
		</a>
	</div>

	<div class="header-nav__container">
		<nav>
			<ul>
				{
					navData.map(navItem => (
						<li class="header-nav__item">
							<a href={`/${lang}${navItem.slug}`}>{t(navItem.title)}</a>
						</li>
					))
				}
			</ul>
		</nav>
	</div>
	<div class="header-action-item__container">
		<LanguageToggle />
		<Burger
			id="menuButton"
			aria-label={t('Menua ireki')}
			data-open-label={t('Menua ireki')}
			data-close-label={t('Menua itxi')}
			navData={nav}
		/>
		<slot name="action-item" />
	</div>
</header>
<div id="menu-overlay" class="menu-overlay">
	<!-- Place logo as a menu item at the top with effect -->

	<nav class="coming-soon-menu-nav">
		<ul>
			{
				navData?.map((navItem, i) => (
					<li
						class="coming-soon-menu-item"
						style={`transition-delay: ${(i + 1) * 80 + 200}ms`}
					>
						<a href={`/${lang}${navItem.slug}`}>{t(navItem.title)}</a>
					</li>
				))
			}
		</ul>
	</nav>
	<div
		class="coming-soon-menu-item logo-menu-item"
		style="transition-delay: 120ms"
	>
		<LogoIsotipoWhite width={128} height={128} />
	</div>
</div>

<style>
	header {
		width: 100%;
		padding: 0 0.5rem;
		height: var(--header-height);
		display: flex;
		justify-content: space-between;
		align-items: center;
		position: fixed;
		top: 0;
		z-index: 200;
		transition:
			all 0.3s ease-in-out,
			transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		background-color: var(--theme-bg);
		padding-top: var(--s3);
	}

	header.header-nav__container--scrolling-down {
		padding-top: 0;
	}
	header.header--hidden {
		transform: translateY(-100%);
	}
	header.header--right {
		display: grid;
		grid-template-columns: 1fr auto auto auto;
	}
	.header-logo__link {
		width: fit-content;
		color: inherit;
		text-decoration: none;
		height: 100%;
		aspect-ratio: 1 / 1;
		width: var(--s5);
		padding: var(--s4) 0;
		svg {
			width: var(--s10);
		}
	}
	.header-logo-menu__container {
		display: flex;
		align-items: center;
		height: 100%;
	}

	.header-action-item__container {
		display: flex;
		gap: var(--s);
	}
	.header-nav__container--scrolled {
		box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
		margin-top: 0;
		opacity: 0.9;
		backdrop-filter: blur(10px);
	}

	header[open] {
		background-color: transparent;
		z-index: 1111;
		.language-toggle,
		.header-logo-menu__container {
			opacity: 0;
		}
	}
	.header-nav__container--scrolling-down {
		height: var(--s8);
		background-color: var(--theme-primary-container);
	}

	nav {
		display: flex;
	}
	nav ul {
		margin: 0;
		padding: 0;
		list-style: none;
		display: flex;
	}
	nav ul li:not(.coming-soon-menu-item) a {
		text-decoration: none;
		margin-right: 1rem;
		opacity: 0.72;
		transition: opacity linear 150ms;
	}
	nav ul li a:hover {
		opacity: 1;
	}

	.language-select__container {
		z-index: 100;
		transition: opacity 0.3s ease-in-out;
	}

	@media (max-width: 768px) {
		.header-nav__container {
			display: none;
		}
		#menuButton {
			display: flex;
		}
	}

	.menu-overlay {
		position: fixed;
		inset: 0;
		z-index: 1000;
		background: var(--theme-primary);
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		overflow: hidden;
		opacity: 0;
		pointer-events: none;
		transition:
			opacity 0.3s cubic-bezier(0.4, 2, 0.6, 1),
			transform 0.4s cubic-bezier(0.4, 2, 0.6, 1);
		transform: translateX(100vw); /* Start off-screen right */
	}
	.menu-overlay.open {
		opacity: 1;
		pointer-events: auto;
		transform: translateX(0);
	}

	.coming-soon-menu-nav ul {
		list-style: none;
		padding: 0;
		margin: 0;
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: var(--s5);
	}

	.coming-soon-menu-item {
		opacity: 0;
		transform: translateY(40px) scale(0.95);
		transition:
			opacity 0.4s cubic-bezier(0.4, 2, 0.6, 1),
			transform 0.4s cubic-bezier(0.4, 2, 0.6, 1);
	}
	.menu-overlay.open .coming-soon-menu-item {
		opacity: 1;
		transform: translateY(0) scale(1);
	}

	.coming-soon-menu-item a {
		font-size: var(--font-size-lg);
		color: var(--theme-on-primary, #fff);
		text-decoration: none;
		font-weight: 700;
		letter-spacing: 0.08em;

		transition: color 0.2s;
	}
	.coming-soon-menu-item a:hover {
		color: var(--theme-secondary, #e8944a);
		text-shadow:
			0 2px 32px #e8944a,
			0 0 2px #fff;
	}

	.logo-menu-item {
		display: flex;
		justify-content: center;
		align-items: center;
		margin-bottom: var(--s5);
		/* Inherit menu item animation */
		opacity: 0;
		transform: translateY(40px) scale(0.95);
		transition:
			opacity 0.4s cubic-bezier(0.4, 2, 0.6, 1),
			transform 0.4s cubic-bezier(0.4, 2, 0.6, 1);
		position: absolute;
		top: var(--s6);
	}
	.menu-overlay.open .logo-menu-item {
		opacity: 1;
		transform: translateY(0) scale(1);
	}
</style>

<script>
	document.addEventListener('astro:page-load', () => {
		const bodyElement = document.body;
		const navHeader = document.getElementById('laguntzaFisioterapiaNavHeader');
		const mobileMenu = document.getElementById('mobile-menu');
		const btn = document.getElementById('lang-toggle-btn');
		const dropdown = document.getElementById('lang-dropdown');
		const menuButton = document.getElementById('menuButton');

		let lastScrollY = window.scrollY;
		let ticking = false;
		let languageToggleIsOpen = false;

		if (!menuButton || !navHeader || !bodyElement) return;

		const { openLabel, closeLabel } = menuButton.dataset;

		// --- Language Dropdown Logic ---
		function openDropdown() {
			if (!dropdown || !btn) return;
			dropdown.hidden = false;
			btn.setAttribute('aria-expanded', 'true');
			languageToggleIsOpen = true;
		}
		function closeDropdown() {
			if (!dropdown || !btn) return;
			dropdown.hidden = true;
			btn.setAttribute('aria-expanded', 'false');
			languageToggleIsOpen = false;
		}

		function handleDropdownEvents() {
			if (!btn || !dropdown) return;
			btn.addEventListener('click', e => {
				e.stopPropagation();
				languageToggleIsOpen ? closeDropdown() : openDropdown();
			});
			btn.addEventListener('blur', () => {
				setTimeout(() => {
					if (!dropdown.contains(document.activeElement)) closeDropdown();
				}, 100);
			});
			dropdown.addEventListener('mousedown', e => e.preventDefault());
			dropdown.querySelectorAll('.lang-option').forEach(option => {
				option.addEventListener('click', () => {
					const lang = option.getAttribute('data-lang');
					const event = new CustomEvent('languageChange', {
						detail: lang,
						bubbles: true,
					});
					btn.dispatchEvent(event);
					closeDropdown();
					btn.focus();
				});
			});
			document.addEventListener('click', e => {
				if (btn !== e.target && dropdown !== e.target) closeDropdown();
			});
		}

		function onScroll() {
			if (menuButton && menuButton.hasAttribute('open')) return;
			const currentScrollY = window.scrollY;
			if (!navHeader) return;
			// Hide dropdown on scroll
			if (dropdown && btn && window.scrollY > 60 && !dropdown.hidden) {
				closeDropdown();
				btn.blur();
			}
			// Prevent scroll logic if mobile menu is open
			if (mobileMenu && mobileMenu.hasAttribute('open')) {
				navHeader.classList.remove('header-nav__container--scrolling-down');
				return;
			}
			// Twitter-like header hide/show
			if (currentScrollY < 60) {
				navHeader.classList.remove('header-nav__container--scrolled');
			} else {
				navHeader.classList.add('header-nav__container--scrolled');

				if (currentScrollY > lastScrollY) {
					navHeader.classList.add('header-nav__container--scrolling-down');
				} else {
					navHeader.classList.remove('header-nav__container--scrolling-down');
				}
			}
			lastScrollY = currentScrollY;
			ticking = false;
		}
		function onScrollHandler() {
			if (!ticking) {
				window.requestAnimationFrame(onScroll);
				ticking = true;
			}
		}
		window.addEventListener('scroll', onScrollHandler);

		// --- Init ---
		handleDropdownEvents();

		const menuOverlay = document.getElementById('menu-overlay');
		const header = document.getElementById('laguntzaFisioterapiaNavHeader');
		if (!menuButton || !menuOverlay) return;

		function openMenu() {
			if (!menuOverlay || !menuButton) return;
			header?.setAttribute('open', '');
			menuOverlay.classList.remove('open');
			menuOverlay.style.display = 'flex';
			// Force reflow to ensure transition triggers
			void menuOverlay.offsetWidth;
			menuOverlay.classList.add('open');
			menuButton.setAttribute('aria-label', closeLabel || 'Close menu');
			setTimeout(() => {
				menuButton.setAttribute('open', '');
			}, 100);
			document.body.style.overflow = 'hidden'; // Disable scroll
		}
		function closeMenu() {
			if (!menuOverlay || !menuButton) return;
			header?.removeAttribute('open');

			menuOverlay.classList.remove('open');
			menuButton.removeAttribute('open');
			document.body.style.overflow = ''; // Restore scroll
			menuButton.setAttribute('aria-label', openLabel || 'Close menu');

			setTimeout(() => {
				menuOverlay.style.display = 'none';
			}, 400); // match CSS transition
		}

		function menuToggle() {
			if (!menuOverlay || !menuButton) return;
			if (menuButton.hasAttribute('open')) {
				closeMenu();
			} else {
				openMenu();
			}
		}

		menuButton.addEventListener('click', menuToggle);
		menuOverlay.addEventListener('click', e => {
			if (e.target === menuOverlay) closeMenu();
		});

		// close menu on ESC key
		document.addEventListener('keydown', e => {
			if (e.key === 'Escape' && menuOverlay.classList.contains('open')) {
				closeMenu();
			}
		});
	});
</script>
